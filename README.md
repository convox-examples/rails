# Rails on Convox Example

This repository contains an example Ruby on Rails 4.2 app configured for local development and deployment via Convox.

The following is a step-by-step walkthrough of how the app was configured and why.

## The Rails App

The [first commit](https://github.com/convox-examples/rails/commit/9ea994c33d8828686ed4622a7d40c4001fb19455) contains all the files generated by running `rails new example` via the rails 4.2.6 gem.

## Convox Init

The Convox CLI contains a command called `convox init`, which we used to generate the files in the [second commit](https://github.com/convox-examples/rails/commit/a19de3739d745e44e33e2e494516f6d014eb7eb5), `Dockerfile` and `docker-compose.yml`.

Since Convox uses Docker for containerization, these files are necessary to describe the application's containers and how to build them. 

### Dockerfile

#### convox/rails Docker image

The generated Dockerfile inherits from the [convox/rails Docker image](https://hub.docker.com/r/convox/rails/), which has all the packages and configuration necessary to run your Rails app both locally and in production. This includes:

* OS libraries to support PostgreSQL, MySQL, and sqlite3 databases
* nodejs for compiling Javascript assets
* nginx for proxying client connections
* a Convox-friendly nginx config file
* a convox.rb file for logging to STDOUT
* a bin/web script for booting the app

#### build with optimal caching

Starting from the `convox/rails` image, the generated Dockerfile adds everything else that your particular app needs to build. There are basically 3 steps in this process. They are executed in this particular order to take best advantage of Docker's caching behavior.

First, `Gemfile` and `Gemfile.lock` are copied and `bundle install` is run. This happens first because it is slow and something that's done infrequently. After running once, this step will be cached unless the cache is busted by later edits to `Gemfile` or `Gemfile.lock`.

Next all the files necessary for the Rails asset pipeline are copied, and assets are built. Again, this is done early in the build process to optimize caching. The asset building step will only be run in the future if these files have changed.

Finally, the rest of the application source is copied over. These files will change frequently, so this step of the build will very rarely be cached.

### docker-compose.yml

The `docker-compose.yml` file explains how to run the containers that make up your app. This generated file describes a `web` container which will be your main Rails web process.

#### build

```yaml
build: .
```

This entry declares that the web container should use an image built from the top level of your application directory using the Dockerfile found there.

#### labels

```yaml
labels:
  - convox.port.443.protocol=tls
  - convox.port.443.proxy=true
```

The labels section is used by Convox for configuration not covered by the official Compose spec. Here we're using it to configure how the load balancer handles traffic on port 443.

`convox.port.443.protocol=tls` means that the load balancer listens on port 443 in TLS mode, accepting encrypted traffic and using your application's certificate to decrypt the messages.

`convox.port.443.proxy=true` means that PROXY protocol TCP headers are injected into requests on port 443. These headers can then be used by nginx to set the HTTP headers your Rails application expects.

See the [load balancer documentation] for more detailed info.

#### ports

```yaml
ports:
  - 80:4000
  - 443:4001
```

The ports section describes which ports your application listens on and which ports of the web container they map to. In this case the application is listening on ports 80 and 443 for http and https traffic. These requests get routed to the web container(s) on ports 4000 and 4001, respectively. 
## .dockerignore

This repo also includes a [.dockerignore](https://github.com/convox-examples/rails/blob/master/.dockerignore) file that ignores files and directories not needed in the app's Docker image. It's important to have a good `.dockerignore` to keep images small and builds, pushes and pulls fast.

## Running the app Locally

```bash
convox start
```

## Deploying the application

After [installing a Rack](https://convox.com/docs/installing-a-rack/):

```bash
convox apps create
convox deploy
```

## Going further

This app is using sqlite3 for its database. To see an example using a PostgreSQL database, checkout the [postgres](https://github.com/convox-examples/rails/tree/postgres) branch of this repo.
